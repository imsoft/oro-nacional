# Documentaci√≥n: UPDATE para el Sistema de Blog

## Resumen

Se ha implementado la funcionalidad completa de **actualizaci√≥n de posts** para el sistema de blog de Oro Nacional, incluyendo:

- ‚úÖ P√°gina de edici√≥n con formulario pre-llenado
- ‚úÖ Actualizaci√≥n de todos los campos del post
- ‚úÖ Gesti√≥n de imagen destacada (mantener, eliminar o reemplazar)
- ‚úÖ Actualizaci√≥n de categor√≠a y tags
- ‚úÖ Cambio de estado (draft/published)
- ‚úÖ Regeneraci√≥n autom√°tica de slug al cambiar t√≠tulo
- ‚úÖ Validaci√≥n de campos
- ‚úÖ Estados de carga
- ‚úÖ Navegaci√≥n desde lista de admin

---

## üìã Archivos Creados/Modificados

### 1. P√°gina de Edici√≥n
**Archivo:** [src/app/admin/blog/[id]/editar/page.tsx](../src/app/admin/blog/[id]/editar/page.tsx)

**Caracter√≠sticas:**
```typescript
- Carga post existente por ID
- Pre-llena formulario con datos actuales
- Gesti√≥n avanzada de im√°genes
- Actualizaci√≥n de tags (elimina y recrea)
- Validaci√≥n de campos obligatorios
- Loading y saving states
- Redirecci√≥n despu√©s de guardar
```

### 2. Lista de Admin - Bot√≥n de Editar
**Archivo:** [src/app/admin/blog/page.tsx](../src/app/admin/blog/page.tsx)

**Cambios:**
```typescript
// Agregado Link al bot√≥n de editar
<Link href={`/admin/blog/${post.id}/editar`}>
  <Button>
    <Pencil />
  </Button>
</Link>
```

---

## üé® Caracter√≠sticas del Formulario de Edici√≥n

### Carga Inicial
```typescript
useEffect(() => {
  loadData();
}, [params.id]);

const loadData = async () => {
  const [postData, categoriesData] = await Promise.all([
    getBlogPostById(params.id),
    getBlogCategories(),
  ]);

  // Pre-llenar formulario
  setTitle(postData.title);
  setExcerpt(postData.excerpt || "");
  setContent(postData.content);
  setCategoryId(postData.category_id || "");
  setStatus(postData.status);
  setCurrentFeaturedImage(postData.featured_image || null);
  setTags(postData.tags?.map((tag) => tag.name).join(", ") || "");
};
```

### Gesti√≥n de Im√°genes

#### Estados de Imagen
```typescript
const [currentFeaturedImage, setCurrentFeaturedImage] = useState<string | null>(null);
const [newFeaturedImage, setNewFeaturedImage] = useState<File | null>(null);
const [imagePreview, setImagePreview] = useState<string | null>(null);
```

#### Casos de Uso

**1. Mantener imagen actual:**
- No hacer nada
- currentFeaturedImage se mantiene
- No se env√≠a featured_image en updates

**2. Eliminar imagen actual:**
- Click en X de imagen actual
- setCurrentFeaturedImage(null)
- No se env√≠a featured_image en updates

**3. Reemplazar imagen:**
- Upload nueva imagen
- newFeaturedImage contiene File
- Se env√≠a featured_image: File en updates
- updateBlogPost() sube nueva imagen y actualiza URL

#### UI de Im√°genes

```typescript
// Imagen actual (si existe y no hay preview de nueva)
{currentFeaturedImage && !imagePreview && (
  <div>
    <img src={currentFeaturedImage} />
    <Button onClick={handleRemoveCurrentImage}>
      <X />
    </Button>
  </div>
)}

// Upload (si no hay imagen actual ni preview)
{!imagePreview && !currentFeaturedImage && (
  <label htmlFor="featured-image">
    <Upload />
  </label>
)}

// Preview de nueva imagen
{imagePreview && (
  <div>
    <img src={imagePreview} />
    <Button onClick={handleRemoveNewImage}>
      <X />
    </Button>
  </div>
)}
```

### Actualizaci√≥n de Datos

```typescript
const handleSubmit = async (e: React.FormEvent) => {
  e.preventDefault();

  // Validaciones
  if (!title.trim()) {
    alert("El t√≠tulo es obligatorio");
    return;
  }

  if (!content.trim()) {
    alert("El contenido es obligatorio");
    return;
  }

  // Preparar updates
  const updates = {
    title: title.trim(),
    excerpt: excerpt.trim() || undefined,
    content: content.trim(),
    featured_image: newFeaturedImage || undefined,
    category_id: categoryId || undefined,
    status,
    tags: tags.split(",").map((t) => t.trim()).filter((t) => t.length > 0),
  };

  // Actualizar
  const result = await updateBlogPost(params.id, updates);

  if (result) {
    alert("Post actualizado exitosamente");
    router.push("/admin/blog");
  }
};
```

---

## üîß Funci√≥n de Update en Supabase

### En [src/lib/supabase/blog.ts](../src/lib/supabase/blog.ts)

```typescript
export async function updateBlogPost(
  postId: string,
  updates: UpdateBlogPostData
): Promise<BlogPost | null> {
  try {
    const dataToUpdate: Record<string, unknown> = {};

    // 1. Actualizar campos b√°sicos
    if (updates.title) {
      dataToUpdate.title = updates.title;
      // Regenerar slug si cambia el t√≠tulo
      dataToUpdate.slug = updates.title
        .toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .replace(/[^a-z0-9]+/g, "-")
        .replace(/^-+|-+$/g, "");
    }

    if (updates.excerpt !== undefined) dataToUpdate.excerpt = updates.excerpt;
    if (updates.content) dataToUpdate.content = updates.content;
    if (updates.category_id !== undefined)
      dataToUpdate.category_id = updates.category_id || null;

    // 2. Actualizar estado y published_at
    if (updates.status) {
      dataToUpdate.status = updates.status;
      // Si se publica por primera vez, establecer published_at
      if (updates.status === "published") {
        const { data: currentPost } = await supabase
          .from("blog_posts")
          .select("published_at")
          .eq("id", postId)
          .single();

        if (currentPost && !currentPost.published_at) {
          dataToUpdate.published_at = new Date().toISOString();
        }
      }
    }

    // 3. Subir nueva imagen si existe
    if (updates.featured_image) {
      const { data: currentPost } = await supabase
        .from("blog_posts")
        .select("slug")
        .eq("id", postId)
        .single();

      const slug = currentPost?.slug || "post";
      const fileExt = updates.featured_image.name.split(".").pop();
      const fileName = `${Date.now()}-${slug}.${fileExt}`;

      const { error: uploadError } = await supabase.storage
        .from("blog-images")
        .upload(fileName, updates.featured_image);

      if (!uploadError) {
        const { data: { publicUrl } } = supabase.storage
          .from("blog-images")
          .getPublicUrl(fileName);

        dataToUpdate.featured_image = publicUrl;
      }
    }

    // 4. Actualizar el post
    const { data: post, error: updateError } = await supabase
      .from("blog_posts")
      .update(dataToUpdate)
      .eq("id", postId)
      .select()
      .single();

    if (updateError) throw updateError;

    // 5. Actualizar tags si se proporcionaron
    if (updates.tags) {
      // Eliminar tags actuales
      await supabase.from("blog_post_tags").delete().eq("post_id", postId);

      // Crear o obtener nuevas tags
      if (updates.tags.length > 0) {
        const tags = await getOrCreateTags(updates.tags);

        const postTagRelations = tags.map((tag) => ({
          post_id: postId,
          tag_id: tag.id,
        }));

        await supabase.from("blog_post_tags").insert(postTagRelations);
      }
    }

    return post;
  } catch (error) {
    console.error("Error in updateBlogPost:", error);
    return null;
  }
}
```

---

## üìù Campos del Formulario

### Informaci√≥n B√°sica

| Campo | Tipo | Obligatorio | Descripci√≥n |
|-------|------|-------------|-------------|
| T√≠tulo | Input | ‚úÖ S√≠ | Regenera slug autom√°ticamente |
| Extracto | Textarea | ‚ùå No | Resumen para tarjetas |
| Contenido | Textarea | ‚úÖ S√≠ | Texto completo con Markdown |

### Clasificaci√≥n

| Campo | Tipo | Obligatorio | Descripci√≥n |
|-------|------|-------------|-------------|
| Categor√≠a | Select | ‚ùå No | Dropdown con categor√≠as de BD |
| Etiquetas | Input | ‚ùå No | Separadas por comas |

### Imagen Destacada

| Acci√≥n | Descripci√≥n |
|--------|-------------|
| Mantener | No tocar nada |
| Eliminar | Click en X de imagen actual |
| Reemplazar | Upload nueva imagen |

### Publicaci√≥n

| Campo | Valores | Descripci√≥n |
|-------|---------|-------------|
| Estado | draft / published | Cambia visibilidad p√∫blica |

---

## üîÑ Flujo de Actualizaci√≥n

### 1. Carga Inicial
```
useEffect ‚Üí loadData()
  ‚Üì
getBlogPostById(id) + getBlogCategories()
  ‚Üì
Pre-llenar formulario con datos actuales
  ‚Üì
Mostrar imagen actual (si existe)
```

### 2. Modificaci√≥n
```
Usuario edita campos
  ‚Üì
Estado local se actualiza
  ‚Üì
Preview de nueva imagen (si se sube)
```

### 3. Guardar
```
handleSubmit()
  ‚Üì
Validar campos obligatorios
  ‚Üì
Preparar objeto updates
  ‚Üì
updateBlogPost(id, updates)
  ‚Üì
Actualizar en BD + Subir imagen + Actualizar tags
  ‚Üì
Redirigir a /admin/blog
```

---

## üéØ Comportamiento Especial

### Regeneraci√≥n de Slug
```typescript
// Si se cambia el t√≠tulo, se regenera el slug
if (updates.title) {
  dataToUpdate.slug = generateSlug(updates.title);
}
```

### Published At
```typescript
// Solo se establece published_at la primera vez que se publica
if (updates.status === "published") {
  const currentPost = await getPost(postId);
  if (!currentPost.published_at) {
    dataToUpdate.published_at = NOW();
  }
}
```

### Gesti√≥n de Tags
```typescript
// Se eliminan todos los tags actuales y se recrean
await deletePostTags(postId);
const newTags = await getOrCreateTags(tagNames);
await createPostTagRelations(postId, newTags);
```

### Gesti√≥n de Im√°genes
```typescript
// Solo se sube nueva imagen si se proporciona File
if (updates.featured_image instanceof File) {
  const url = await uploadImage(updates.featured_image);
  dataToUpdate.featured_image = url;
}
// Si no se proporciona, la imagen actual se mantiene
```

---

## ‚úÖ Validaciones

### Client-Side
```typescript
‚úÖ T√≠tulo no vac√≠o
‚úÖ Contenido no vac√≠o
‚úÖ Usuario autenticado
```

### Server-Side (RLS)
```sql
-- Solo admins pueden actualizar posts
UPDATE blog_posts ... WHERE
  EXISTS (
    SELECT 1 FROM profiles
    WHERE id = auth.uid() AND role = 'admin'
  )
```

---

## üé® Estados de UI

### Loading
```typescript
if (isLoading) {
  return <Loader2 className="animate-spin" />;
}
```

### Not Found
```typescript
if (!post) {
  return (
    <div>
      <p>Post no encontrado</p>
      <Link href="/admin/blog">Volver</Link>
    </div>
  );
}
```

### Saving
```typescript
<Button disabled={isSaving}>
  {isSaving ? (
    <>
      <Loader2 className="animate-spin" />
      Guardando...
    </>
  ) : (
    <>
      <Save />
      Guardar Cambios
    </>
  )}
</Button>
```

---

## üß™ Casos de Prueba

### Actualizaci√≥n de Contenido
- [ ] Cambiar t√≠tulo regenera slug correctamente
- [ ] Actualizar extracto se refleja en tarjetas
- [ ] Modificar contenido se guarda correctamente
- [ ] Tags se actualizan (eliminan viejos, crean nuevos)

### Gesti√≥n de Im√°genes
- [ ] Mantener imagen actual funciona
- [ ] Eliminar imagen actual funciona
- [ ] Subir nueva imagen reemplaza la anterior
- [ ] Preview de nueva imagen se muestra

### Cambio de Estado
- [ ] Cambiar de draft a published establece published_at
- [ ] Cambiar de published a draft mantiene published_at
- [ ] Post borrador no aparece en blog p√∫blico
- [ ] Post publicado aparece inmediatamente

### Categor√≠as y Tags
- [ ] Cambiar categor√≠a se refleja en todos lados
- [ ] Tags nuevos se crean
- [ ] Tags existentes se reutilizan
- [ ] Tags vac√≠os se ignoran

### Validaci√≥n
- [ ] No permite guardar sin t√≠tulo
- [ ] No permite guardar sin contenido
- [ ] Redirect funciona despu√©s de guardar
- [ ] Mensaje de √©xito se muestra

---

## üöÄ Mejoras Futuras

### Editor Mejorado
- Rich text editor (Tiptap, Lexical)
- Vista previa del Markdown
- Inserci√≥n de im√°genes en contenido
- Autoguardado

### Gesti√≥n de Im√°genes
- Galer√≠a de im√°genes
- Crop y resize de im√°genes
- Optimizaci√≥n autom√°tica
- CDN para im√°genes

### Versionado
- Historial de cambios
- Restaurar versiones anteriores
- Ver diff entre versiones

### Colaboraci√≥n
- M√∫ltiples autores
- Comentarios en borrador
- Flujo de aprobaci√≥n

---

## üìö Referencias

- **Tipos:** [src/types/blog.ts](../src/types/blog.ts)
- **Update Function:** [src/lib/supabase/blog.ts](../src/lib/supabase/blog.ts) (l√≠nea ~500+)
- **P√°gina de Edici√≥n:** [src/app/admin/blog/[id]/editar/page.tsx](../src/app/admin/blog/[id]/editar/page.tsx)
- **Lista Admin:** [src/app/admin/blog/page.tsx](../src/app/admin/blog/page.tsx)
- **Database:** [database/blog-setup.sql](../database/blog-setup.sql)

---

## ‚úÖ Resumen de Completado

| Funcionalidad | Estado |
|---------------|--------|
| Formulario de Edici√≥n | ‚úÖ Completado |
| Pre-llenado de Datos | ‚úÖ Completado |
| Gesti√≥n de Im√°genes | ‚úÖ Completado |
| Actualizaci√≥n de Tags | ‚úÖ Completado |
| Cambio de Estado | ‚úÖ Completado |
| Validaciones | ‚úÖ Completado |
| Loading States | ‚úÖ Completado |
| Navegaci√≥n | ‚úÖ Completado |
| Regeneraci√≥n de Slug | ‚úÖ Completado |

---

## üéâ Pr√≥ximo Paso

Para completar el CRUD del blog:

**DELETE** - Eliminar posts
- Modal de confirmaci√≥n personalizado
- Informaci√≥n del post a eliminar
- Hard delete (eliminar permanentemente)
- Redirecci√≥n despu√©s de eliminar

¬°El UPDATE est√° 100% funcional! üé®
